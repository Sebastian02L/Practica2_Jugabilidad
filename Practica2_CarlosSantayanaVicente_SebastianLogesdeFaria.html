<!DOCTYPE html>
<html>

<head>
    <title> Practica 2</title>
</head>

<body>
    <p> Autores: Sebastián Loges de Faría y Carlos Santayana Vicente. 25/11/2022</p>

    <canvas id="lienzo" width="600" height="600" style="border: 1px solid black; background-color: white;"> </canvas>

    <br><br>

    <p id="parrafoPoblacion">Población actual: 0</p>
    <p id = "parrafo1">Simulación detenida: Paso 0</p>
    <p id = "parrafo2"></p>

    <button id="botonI">INICIAR SIMULACIÓN</button>
    <button id="botonD">DETENER SIMULACIÓN</button>
    <br><br>
    <button id="botonVA">AUMENTAR VELOCIDAD DE LA SIMULACIÓN</button>
    <button id="botonVD">DISMINUIR VELOCIDAD DE LA SIMULACIÓN</button>
    <br><br>
    <button id="botonR">REINICIAR LA SIMULACIÓN</button>

    <script>
        window.onload = function(){
            //BOTONES
            var botonI = document.getElementById("botonI");
            var botonD = document.getElementById("botonD");
            var botonVA = document.getElementById("botonVA");
            var botonVD = document.getElementById("botonVD");
            var botonR = document.getElementById("botonR");

            //PARRAFOS
            var parrafoPoblacion = document.getElementById("parrafoPoblacion");
            var parrafo1 = document.getElementById("parrafo1");
            var parrafo2 = document.getElementById("parrafo2");

            //CANVAS
            var canvas = document.getElementById("lienzo");
            var contexto = canvas.getContext("2d");

            //CLASE CELULA
            function celula() {
                //Atributos de clase y su inicilización
                this.estado = false; //Viva(true) o muerta(false)
                this.tiempo = 0; //Tiempo que lleva viva o muerta, comienza en 0

                //Métodos
                this.encender = function(){
                    this.estado = true;
                    this.tiempo = 0;
                    numPoblacion++;
                }

                this.apagar = function(){
                    this.estado = false;
                    this.tiempo = 0;
                    numPoblacion--;
                }
            }

            //CLASE MUNDO
            function mundo(numeroCelulas = 40, numeroPasos = 10) {
                //Atributos de clase y su inicialización
                this.ancho = numeroCelulas; //Tamaño N de ancho y alto de la cuadrícula
                this.pixeles = 600 / this.ancho; //Número de píxeles que corresponden a cada columna
                this.pasos = numeroPasos; //Pasos que transcurren por segundo en el mundo
                this.contadorPasos = 0;
                this.matriz = new Array(numeroCelulas);

                for (var i = 0; i < this.ancho; ++i) {
                    this.matriz[i] = new Array(this.ancho);
                }

                for(var i = 0; i < this.ancho; ++i){
                    for(var j = 0; j < this.ancho; ++j){
                        this.matriz[i][j] = new celula();
                    }
                }
                
                //Métodos
                this.dibujaCuadricula = function(){
                    var numLineas = this.ancho - 1; //Número de líneas a dibujar en la cuadrícula
                    var grosorActual = this.pixeles; //Grosor en cada iteración

                    for (var i = 0; i < numLineas; ++i) {
                        contexto.beginPath();
                        contexto.moveTo(grosorActual, 0);
                        contexto.lineTo(grosorActual, 600);
                        contexto.moveTo(grosorActual, 0);
                        contexto.stroke();
                        grosorActual += this.pixeles;
                    }

                    grosorActual = this.pixeles;

                    for (var i = 0; i < numLineas; ++i) {
                        contexto.beginPath();
                        contexto.moveTo(0, grosorActual);
                        contexto.lineTo(600, grosorActual);
                        contexto.moveTo(0, grosorActual);
                        contexto.stroke();
                        grosorActual += this.pixeles;
                    }
                }

                this.encontrarCelda = function(coordXCanvas,coordYCanvas){
                    var encontrado = false;
                    var medidaX = this.pixeles;
                    var medidaY = this.pixeles;
                    var indiceC = 0;
                    var indiceF = 0;
                    
                    while(!encontrado){
                        if(medidaX<coordXCanvas){
                            medidaX += this.pixeles;
                            indiceC += 1;
                        }else{
                            encontrado = true;
                        }
                    }

                    var encontrado = false;

                    while(!encontrado){
                        if(medidaY<coordYCanvas){
                            medidaY += this.pixeles;
                            indiceF += 1;
                        }else{
                            encontrado = true;
                        }
                    }
                    
                    var arrayIndices = [indiceF,indiceC];

                    return arrayIndices;
                }

                this.pintarCelda = function(indiceF,indiceC){
                    if(this.matriz[indiceF][indiceC].estado == false){
                        this.matriz[indiceF][indiceC].encender();
                        contexto.fillRect(this.pixeles*indiceC+1, this.pixeles*indiceF+1, this.pixeles-2, this.pixeles-2);
                    }else{
                        this.matriz[indiceF][indiceC].apagar();
                        contexto.clearRect(this.pixeles*indiceC+1, this.pixeles*indiceF+1, this.pixeles-2, this.pixeles-2);
                    }
                }

                this.comprobarCelulas = function(){
                    matrizAux = new Array(miMundo.ancho);

                    for (var i = 0; i < miMundo.ancho; ++i) {
                        matrizAux[i] = new Array(miMundo.ancho);
                    }

                    for(var p = 0; p < miMundo.pasos; ++p){
                        for(var i = 0; i < miMundo.ancho; ++i){
                            for(var j = 0; j < miMundo.ancho; ++j){
                                if(miMundo.matriz[i][j].estado == true){
                                   matrizAux[i][j]=true;
                                }else{
                                    matrizAux[i][j]=false;
                                }
                            }
                        }

                        for(var i = 0; i < miMundo.ancho; ++i){
                            for(var j = 0; j < miMundo.ancho; ++j){
                                var contador = 0;

                                if(i==0&&j==0){ //ESQUINA SUPERIOR IZQUIERDA
                                    if(matrizAux[miMundo.ancho-1][j] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i][miMundo.ancho-1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[miMundo.ancho-1][miMundo.ancho-1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i+1][j] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i][j+1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i+1][j+1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i+1][miMundo.ancho-1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[miMundo.ancho-1][j+1] == true){
                                        contador++;
                                    }
                                }else if(i==0&&j!=0&&j!=miMundo.ancho-1){ //FILA SUPERIOR
                                    if(matrizAux[miMundo.ancho-1][j] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i][j-1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[miMundo.ancho-1][j-1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i+1][j] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i][j+1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i+1][j+1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i+1][j-1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[miMundo.ancho-1][j+1] == true){
                                        contador++;
                                    }
                                }else if(i==0&&j==miMundo.ancho-1){ //ESQUINA SUPERIOR DERECHA
                                    if(matrizAux[miMundo.ancho-1][j] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i][j-1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[miMundo.ancho-1][j-1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i+1][j] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i][0] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i+1][0] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i+1][j-1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[miMundo.ancho-1][0] == true){
                                        contador++;
                                    }
                                }else if(i!=0&&i!=miMundo.ancho-1&&j==0){ //COLUMNA IZQUIERDA
                                    if(matrizAux[i-1][j] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i][miMundo.ancho-1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i-1][miMundo.ancho-1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i+1][j] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i][j+1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i+1][j+1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i+1][miMundo.ancho-1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i-1][j+1] == true){
                                        contador++;
                                    }
                                }else if(i==miMundo.ancho-1&&j==0){ //ESQUINA INFERIOR IZQUIERDA
                                    if(matrizAux[i-1][j] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i][miMundo.ancho-1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i-1][miMundo.ancho-1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[0][j] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i][j+1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[0][j+1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[0][miMundo.ancho-1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i-1][j+1] == true){
                                        contador++;
                                    }
                                }else if(i==miMundo.ancho-1&&j!=0&&j!=miMundo.ancho-1){ //FILA INFERIOR
                                    if(matrizAux[i-1][j] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i][j-1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i-1][j-1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[0][j] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i][j+1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[0][j+1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[0][j-1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i-1][j+1] == true){
                                        contador++;
                                    }
                                }else if(i==miMundo.ancho-1&&j==miMundo.ancho-1){ //ESQUINA INFERIOR DERECHA
                                    if(matrizAux[i-1][j] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i][j-1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i-1][j-1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[0][j] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i][0] == true){
                                        contador++;
                                    }
                                    if(matrizAux[0][0] == true){
                                        contador++;
                                    }
                                    if(matrizAux[0][j-1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i-1][0] == true){
                                        contador++;
                                    }
                                }else if(i!=0&&i!=miMundo.ancho-1&&j==miMundo.ancho-1){ //COLUMNA DERECHA
                                    if(matrizAux[i-1][j] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i][j-1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i-1][j-1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i+1][j] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i][0] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i+1][0] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i+1][j-1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i-1][0] == true){
                                        contador++;
                                    }
                                }else{ //INTERIOR CUADRÍCULA
                                    if(matrizAux[i-1][j] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i][j-1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i-1][j-1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i+1][j] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i][j+1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i+1][j+1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i+1][j-1] == true){
                                        contador++;
                                    }
                                    if(matrizAux[i-1][j+1] == true){
                                        contador++;
                                    }
                                }

                                if(miMundo.matriz[i][j].estado == true){
                                    if(contador<2||contador>3){
                                        miMundo.matriz[i][j].apagar();
                                        contexto.clearRect(miMundo.pixeles*j+1, miMundo.pixeles*i+1, miMundo.pixeles-2, miMundo.pixeles-2);
                                    }
                                }else{
                                    if(contador == 3){
                                        miMundo.matriz[i][j].encender();
                                        contexto.fillRect(miMundo.pixeles*j+1, miMundo.pixeles*i+1, miMundo.pixeles-2, miMundo.pixeles-2);
                                    }
                                }
                            }
                        }

                        for(var i = 0; i < miMundo.ancho; ++i){
                            for(var j = 0; j < miMundo.ancho; ++j){
                                miMundo.matriz[i][j].tiempo++;
                            }
                        }

                        miMundo.contadorPasos++;
                    }
                    parrafo1.innerHTML = "Simulación en marcha: Paso " + miMundo.contadorPasos;
                    parrafoPoblacion.innerHTML = "Población actual: " + numPoblacion;
                }
            }

            //MANEJADORES
            canvas.addEventListener("click", eventosRaton, false);
            canvas.addEventListener("mousemove",eventosRaton, false);
            botonI.addEventListener("click",eventosRaton,false);
            botonD.addEventListener("click",eventosRaton,false);
            botonVA.addEventListener("click",eventosRaton,false);
            botonVD.addEventListener("click",eventosRaton,false);
            botonR.addEventListener("click",eventosRaton,false);
            
            //FUNCIÓN MANEJADORA DE EVENTOS DE RATON
            function eventosRaton(e) {
                switch(e.type){
                    case "click":
                        if(e.target.id == "botonI"){
                            if(temporizador==undefined){
                                enMarcha = true;
                                temporizador = setInterval(miMundo.comprobarCelulas, UNIDAD_DE_TIEMPO_MS);
                            }
                        }
                        if(e.target.id == "botonD"){
                            enMarcha = false;
                            clearInterval(temporizador);
                            temporizador = undefined;
                            parrafo1.innerHTML = "Simulación detenida: Paso " + miMundo.contadorPasos;
                        }
                        if(e.target.id == "botonVA"){
                            if(enMarcha && UNIDAD_DE_TIEMPO_MS>=100){
                                UNIDAD_DE_TIEMPO_MS -= 100;
                                clearInterval(temporizador);
                                temporizador = setInterval(miMundo.comprobarCelulas, UNIDAD_DE_TIEMPO_MS);
                            }
                        }
                        if(e.target.id == "botonVD"){
                            if(enMarcha){
                                UNIDAD_DE_TIEMPO_MS += 100;
                                clearInterval(temporizador);
                                temporizador = setInterval(miMundo.comprobarCelulas, UNIDAD_DE_TIEMPO_MS);
                            }
                        }
                        if(e.target.id == "botonR"){
                            UNIDAD_DE_TIEMPO_MS = 1000;
                            enMarcha = false;
                            numPoblacion = 0;
                            clearInterval(temporizador);
                            temporizador = undefined;
                            if(CELULAS!=undefined&&PASOS!=undefined){
                                miMundo = new mundo(CELULAS,PASOS);
                            }else{
                                miMundo = new mundo();
                            }
                            contexto.clearRect(0,0,600,600);
                            miMundo.dibujaCuadricula();
                            parrafoPoblacion.innerHTML = "Población actual: " + numPoblacion;
                            parrafo1.innerHTML = "Simulación detenida: Paso " + miMundo.contadorPasos;
                        }
                        if(e.target.id == "lienzo"){
                            const canvasBorder = this.getBoundingClientRect();
                            var celda = miMundo.encontrarCelda(e.pageX - canvasBorder.left, e.pageY - canvasBorder.top);
                            miMundo.pintarCelda(celda[0],celda[1]);
                            parrafoPoblacion.innerHTML = "Población actual: " + numPoblacion;
                        }
                        break;
                    case "mousemove":
                        const canvasBorder = this.getBoundingClientRect();
                        var celda = miMundo.encontrarCelda(e.pageX - canvasBorder.left, e.pageY - canvasBorder.top);
                        if(miMundo.matriz[celda[0]][celda[1]].estado == true){
                            parrafo2.innerHTML = "La célula (" + celda[0] + ", " + celda[1] + ") lleva viva " + miMundo.matriz[celda[0]][celda[1]].tiempo + " pasos.";
                        }else{
                            parrafo2.innerHTML = "La célula (" + celda[0] + ", " + celda[1] + ") lleva muerta " + miMundo.matriz[celda[0]][celda[1]].tiempo + " pasos.";
                        }
                }
            }

            //MAIN
            var CELULAS = 40;
            var PASOS = 1;
            var UNIDAD_DE_TIEMPO_MS = 1000;

            var enMarcha = false;

            var numPoblacion = 0;

            var temporizador;

            if(CELULAS!=undefined&&PASOS!=undefined){
                var miMundo = new mundo(CELULAS,PASOS);
            }else{
                var miMundo = new mundo();
            }
            
            miMundo.dibujaCuadricula();
        }
    </script>
</body>

</html>